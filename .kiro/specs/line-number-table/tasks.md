# Implementation Plan

- [ ] 1. 实现基础位置信息结构
  - 创建SourcePosition结构体，包含行号、列号和字节偏移量信息
  - 实现位置信息的创建、合并和格式化方法
  - 添加从TokenInfo创建SourcePosition的转换方法
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 2. 扩展AST节点支持位置信息
  - 创建PositionedExpr包装器，为表达式添加位置信息
  - 修改现有AST结构体，添加可选的位置信息字段
  - 实现位置信息的访问和操作方法
  - _Requirements: 1.1, 1.4, 1.5_

- [ ] 3. 实现行号表数据结构
  - 创建LineNumberEntry和LineNumberTable结构体
  - 实现行号表的添加、查找和管理功能
  - 添加二分查找算法用于高效的位置查询
  - 实现紧凑的内存布局优化
  - _Requirements: 2.1, 2.2, 3.1, 3.2, 3.5, 6.3_

- [ ] 4. 更新Parser生成带位置信息的AST
  - 修改Parser从TokenInfo提取位置信息
  - 为每个解析的表达式创建PositionedExpr
  - 实现嵌套表达式的位置信息合并逻辑
  - 处理位置信息不可用的边界情况
  - _Requirements: 1.1, 1.3, 1.4_

- [ ] 5. 在编译器中添加位置追踪功能
  - 创建PositionTracker结构体用于编译时位置追踪
  - 在Compiler中集成PositionTracker
  - 修改表达式编译方法支持位置信息传递
  - 实现编译时位置信息的状态管理
  - _Requirements: 2.1, 2.2, 6.1_

- [ ] 6. 扩展Chunk结构支持行号表
  - 在Chunk中添加LineNumberTable字段
  - 修改字节码写入方法记录位置信息
  - 实现字节码偏移量到源代码位置的映射
  - 添加位置信息的查询接口
  - _Requirements: 2.1, 2.3, 2.4, 2.5_

- [ ] 7. 修改字节码生成过程记录位置信息
  - 更新emit_byte和相关方法支持位置信息
  - 在生成字节码时自动记录行号表条目
  - 实现位置信息的增量更新逻辑
  - 优化重复行号的过滤机制
  - _Requirements: 2.1, 2.2, 6.1, 6.4_

- [ ] 8. 在虚拟机中添加位置查找功能
  - 在VM中添加根据PC查找源代码位置的方法
  - 实现高效的位置查询算法
  - 添加位置信息缓存机制提升性能
  - 处理位置信息不可用的情况
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 6.2_

- [ ] 9. 实现位置感知的错误报告器
  - 创建ErrorReporter结构体
  - 实现运行时错误的位置信息格式化
  - 添加源代码上下文显示功能
  - 集成编译错误和运行时错误的位置报告
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 10. 扩展错误类型包含位置信息
  - 扩展RuntimeError和CompileError支持位置信息
  - 修改错误创建和传播逻辑
  - 实现错误的位置信息继承机制
  - 添加位置信息的错误恢复策略
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 11. 集成追踪系统支持位置信息
  - 扩展CompilationTrace和ExecutionTrace包含位置信息
  - 修改追踪输出显示源代码位置
  - 在调试模式下提供详细的位置信息
  - 集成现有的追踪配置系统
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 12. 更新反汇编器显示源代码位置
  - 修改Disassembler支持行号表信息
  - 在反汇编输出中显示对应的源代码行号
  - 实现源代码位置的格式化显示
  - 添加可选的源代码上下文显示
  - _Requirements: 5.2, 5.4_

- [ ]* 13. 实现性能优化和内存管理
  - 实现CompactLineNumberEntry紧凑存储格式
  - 添加行号表的采样记录机制
  - 实现位置查询的缓存系统
  - 优化大文件编译的内存使用
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 14. 编写单元测试
  - 为SourcePosition编写测试用例
  - 为LineNumberTable编写测试用例，包括边界条件
  - 为PositionTracker编写测试用例
  - 为ErrorReporter编写测试用例
  - _Requirements: 1.1, 2.1, 3.1, 4.1_

- [ ]* 15. 编写集成测试
  - 编写端到端位置追踪测试
  - 测试复杂嵌套表达式的位置信息
  - 测试错误报告的位置准确性
  - 编写性能基准测试
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 6.1_

- [ ] 16. 集成REPL和工具支持
  - 在REPL中显示带位置信息的错误
  - 实现错误位置的高亮显示
  - 集成命令行工具的位置报告
  - 添加位置信息的配置选项
  - _Requirements: 4.1, 4.2, 4.3, 5.1_